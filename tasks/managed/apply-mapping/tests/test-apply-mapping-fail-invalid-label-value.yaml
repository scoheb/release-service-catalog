---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-apply-mapping-fail-invalid-label-value
  annotations:
    test/assert-task-failure: "run-task"
spec:
  description: |
    Run the apply-mapping task with a snapshot.spec json and a custom mapping provided in
    the data file with tags per component, but one of the tags uses templating
    with an image label and this label has invalid value (including spaces).
    The task should fail on that.
  workspaces:
    - name: tests-workspace
  params:
    - name: ociStorage
      description: The OCI repository where the Trusted Artifacts are stored.
      type: string
  tasks:
    - name: setup
      workspaces:
        - name: data
          workspace: tests-workspace
      taskSpec:
        results:
          - name: SOURCE_DATA_ARTIFACT
            type: string
        workspaces:
          - name: data
        steps:
          - name: setup-values
            image: quay.io/konflux-ci/release-service-utils:d320c36f3d707cd5bfe55fe783f70236c06cc2e5
            script: |
              #!/usr/bin/env sh
              set -eux

              cat > "$(workspaces.data.path)/test_data.json" << EOF
              {
                "mapping": {
                  "components": [
                    {
                      "name": "comp1",
                      "repository": "repo1",
                      "tags": [
                        "tag1-{{timestamp}}",
                        "tag2-{{ timestamp }}",
                        "{{ labels.Badlabel }}"
                      ]
                    }
                  ]
                }
              }
              EOF

              cat > "$(workspaces.data.path)/test_snapshot_spec.json" << EOF
              {
                "application": "myapp",
                "components": [
                  {
                    "name": "comp1",
                    "containerImage": "registry.io/labels@sha256:123456",
                    "source": {
                      "git": {
                        "revision": "testrevision",
                        "url": "myurl"
                      }
                    }
                  }
                ]
              }
              EOF
          - name: create-trusted-artifact
            args:
              - create
              - --store
              - $(params.ociStorage)
              - $(results.SOURCE_DATA_ARTIFACT.path)=$(workspaces.data.path)
            computeResources: { }
            image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:ff35e09ff5c89e54538b50abae241a765b2b7868f05d62c4835bebf0978f3659
            env:
              - name: IMAGE_EXPIRES_AFTER
                value: 1d
              - name: "ORAS_OPTIONS"
                value: "--insecure"
    - name: run-task
      taskRef:
        name: apply-mapping
      params:
        - name: snapshotPath
          value: test_snapshot_spec.json
        - name: dataPath
          value: test_data.json
        - name: ociStorage
          value: $(params.ociStorage)
        - name: SOURCE_DATA_ARTIFACT
          value: "$(tasks.setup.results.SOURCE_DATA_ARTIFACT)=$(workspaces.data.path)"
      runAfter:
        - setup
      workspaces:
        - name: data
          workspace: tests-workspace
